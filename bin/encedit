#! /bin/bash

if [ -z "$1" ]; then
    echo "Usage: $0 <filename>"
else
    if [ -f $(which openssl) ]; then
        if [ ! -f $1 ]; then
            # Open a new file and encrypt it when we close
            $EDITOR /tmp/$1
            $(which openssl) aes-256-cbc -a -salt -in /tmp/$1 -out $1.enc 2>/dev/null && rm /tmp/$1
        else
            # Open the encrypted file, and add it to /tmp with as little rights as possible
            unencfile=$(echo $1|sed -e s/.enc$/.dec/g)
            mode=$(/usr/bin/stat -c "%a" $1)

            $(which openssl) aes-256-cbc -d -a -in $1 -out /tmp/$unencfile || cp $1 /tmp/$unencfile
            chmod 600 /tmp/$unencfile
            $EDITOR /tmp/$unencfile
            $(which openssl) aes-256-cbc -a -salt -in /tmp/$unencfile -out $1 && rm /tmp/$unencfile
            chmod $mode $1
        fi
    else
        echo "No openssl on the system"
    fi
fi
